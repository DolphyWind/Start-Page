{% load static %}
{% load space_to_hyphen %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Settings</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <link rel="stylesheet" href="{% static 'css/style.css' %}">

    <script>
        function selectItem(item){
            var search_engine_dropdown = document.getElementById("search_engine_dropdown");
            search_engine_dropdown.innerHTML = item.innerHTML;
        }

        function getElementByPlaceholderText(item, placeholderText) {
          const elements = item.querySelectorAll("*");

          for (const element of elements) {
            if (element.placeholder === placeholderText) {
              return element;
            }
          }

          return null;
        }

        function removeSearchEngine(item){
            let nameLabel = getElementByPlaceholderText(item.parentNode, "Name");
            let name = nameLabel.value;
            let idName = name.replaceAll(" ", "-");

            let choiceElement = document.getElementById("search-engine-choice-${idName}".replaceAll("${idName}", idName));
            let search_engine_dropdown = document.getElementById("search_engine_dropdown");
            choiceElement.remove();
            item.parentNode.remove();

            if(search_engine_dropdown.innerHTML === choiceElement.innerHTML){
                try {
                    search_engine_dropdown.innerHTML = document.getElementById("search_engines").querySelector(".form_row").querySelector('[id*="search-engine-name"]').value;
                }
                catch (e) {
                    search_engine_dropdown.innerHTML = "";
                }
            }
        }

        function isValidId(str) {
          // Create a regular expression to match valid IDs.
          const regex = /^[a-zA-Z][a-zA-Z0-9_:\-]*$/;

          // Return true if the string matches the regular expression, false otherwise.
          return regex.test(str);
        }

        function addSearchEngine(item){
            let nameInput = document.getElementById("add_search_engine_name");
            let urlInput = document.getElementById("add_search_engine_url");

            let name = nameInput.value.trim();
            let url = urlInput.value.trim();

            if(!name || !url){
                return;
            }

            let idName = name.replaceAll(" ", "-");
            if(!isValidId(idName)){
                return;
            }
            nameInput.value = "";
            urlInput.value = "";

            // Replace it if exists
            let alreadyExistingItem = document.getElementById("search-engine-url-${idname}".replaceAll("${idname}", idName))
            if(alreadyExistingItem !== null){
                alreadyExistingItem.value = url;
                return;
            }

            let search_engines_list = document.getElementById("search_engines");
            const templateStr = '<div class="form_row"><label class="settings_label mx-2">Name</label>&nbsp;&nbsp;<input type="text" class="form-control settings_input_box_small" placeholder="Name" value="${name}" id="search-engine-name-${idName}" readonly><label class="settings_label mx-2">Url</label><input type="text" class="form-control settings_input_box_big" placeholder="Url" value="${url}" id="search-engine-url-${idName}" readonly>&nbsp;&nbsp;&nbsp;&nbsp;<button class="btn btn-danger settings_plusminus" onclick="removeSearchEngine(this);">X</button></div>';
            search_engines_list.innerHTML += templateStr.replaceAll("${name}", name).replaceAll("${url}", url).replaceAll("${idName}", idName);

            let search_engine_dropdown = document.getElementById("search-engine-dropdown");
            const templateChoiceStr = '<a class="dropdown-item" href="javascript:void(0);" data-value="${name}" onclick="selectItem(this);" id="search-engine-choice-${idName}">${name}</a>';
            search_engine_dropdown.innerHTML += templateChoiceStr.replaceAll("${name}", name).replaceAll("${idName}", idName);

            if(document.getElementById("search_engine_dropdown").innerHTML === ""){
                document.getElementById("search_engine_dropdown").innerHTML = name;
            }
        }

        function removeCurrency(item){
            item.parentNode.remove();
        }

        function addCurrency(item){
            let addCurrencyBaseInput = document.getElementById("add-currency-base");
            let addCurrencyTargetInput = document.getElementById("add-currency-target");

            let baseStr = addCurrencyBaseInput.value.trim().toUpperCase();
            let targetStr = addCurrencyTargetInput.value.trim().toUpperCase();

            if(!baseStr || !targetStr){
                return;
            }

            addCurrencyBaseInput.value = "";
            addCurrencyTargetInput.value = "";

            let currencyList = document.getElementById("currency-list");
            const templateStr = '<div class="form_row"><label class="settings_label mx-2">Base</label>&nbsp;&nbsp;<input type="text" class="form-control settings_input_box_small currency_base_class" placeholder="Base Currency" value="${base}" readonly><label class="settings_label mx-2">Target</label><input type="text" class="form-control settings_input_box_small currency_target_class" placeholder="Target Currency" value="${target}" readonly>&nbsp;&nbsp;&nbsp;&nbsp;<button class="btn btn-danger settings_plusminus" onclick="removeCurrency(this);">X</button></div>';

            currencyList.innerHTML += templateStr.replaceAll("${base}", baseStr).replaceAll("${target}", targetStr);
        }

        function removeCategory(item){
            item.parentNode.remove();
        }

        function removeCategoryItem(item){
            item.parentNode.remove();
        }

        function addWebsiteToCategory(item, category_name){
            let addWebsiteNameInput = document.getElementById("${category_name}-add-website-name".replaceAll("${category_name}", category_name));
            let addWebsiteUrlInput = document.getElementById("${category_name}-add-website-url".replaceAll("${category_name}", category_name));

            let name = addWebsiteNameInput.value.trim();
            let url = addWebsiteUrlInput.value.trim();

            if(!name || !url){
                return;
            }

            addWebsiteNameInput.value = "";
            addWebsiteUrlInput.value = "";

            let websiteListItem = document.getElementById("${category_name}-website-list".replaceAll("${category_name}", category_name) );
            let templateStr = '<div class="form_row"><label class="settings_label mx-2">Name</label>&nbsp;&nbsp;<input type="text" class="form-control settings_input_box_small content_website_name" placeholder="Name" value="${name}" readonly><label class="settings_label mx-2">Url</label>&nbsp;&nbsp;<input type="text" class="form-control settings_input_box_big content_website_url" placeholder="Url" value="${url}" readonly>&nbsp;&nbsp;&nbsp;&nbsp;<button class="btn btn-danger settings_plusminus" onclick="removeCategoryItem(this);">X</button></div>';

            websiteListItem.innerHTML += templateStr.replaceAll("${name}", name).replaceAll("${url}", url);
        }

        function addCategory(item) {
            let addCategoryName = document.getElementById("add-category-name");
            let name = addCategoryName.value;
            let idName = name.replaceAll(" ", "-");

            if(!name || !idName){
                return;
            }

            addCategoryName.value = "";

            let categoriesList = document.getElementById("categories_list");
            let templateStr = '<div class="category_row"><h2 class="settings_label settings_content_title category_title">${name}</h2><div id="${idName}-website-list"></div>\n' +
                '                    <h4 class="settings_label">Add a website to this category</h4>\n' +
                '                    <div class="form_row">\n' +
                '                        <label class="settings_label mx-2">Name</label>&nbsp;&nbsp;\n' +
                '                        <input type="text" class="form-control settings_input_box_small" placeholder="Name" id="${idName}-add-website-name">\n' +
                '                        <label class="settings_label mx-2">Url</label>\n' +
                '                        <input type="text" class="form-control settings_input_box_big" placeholder="Url" id="${idName}-add-website-url">&nbsp;&nbsp;&nbsp;&nbsp;\n' +
                '                        <button class="btn btn-primary settings_plusminus" onclick="addWebsiteToCategory(this, \'${idName}\');">＋</button>\n' +
                '                    </div>\n' +
                '                    <button class="btn btn-danger" onclick="removeCategory(this);">Delete This Category</button>\n' +
                '                    <br><br><br>';
            let finalStr = templateStr.replaceAll("${name}", name).replaceAll("${idName}", idName);
            categoriesList.innerHTML += finalStr;
        }

        function saveSettings() {
            let search_engines = {};
            let name = "";
            let lat = 0;
            let lng = 0;
            let currentSearchEngine = "";
            let currencyList = [];
            let categoriesList = [];

            let nameInput = document.getElementById("nameOption");
            let latitudeInput = document.getElementById("latitude");
            let longitudeInput = document.getElementById("longitude");

            let searchEnginesDiv = document.getElementById("search_engines");
            let searchEngineItems = searchEnginesDiv.querySelectorAll(".form_row");
            searchEngineItems.forEach(item => {
                let search_engine_name = item.querySelector('[id*="search-engine-name"]').value;
                let search_engine_url = item.querySelector('[id*="search-engine-url"]').value;

                search_engines[search_engine_name] = search_engine_url;
            });

            let currenciesDiv = document.getElementById("currency-list");
            let currenciesItems = currenciesDiv.querySelectorAll('.form_row');
            currenciesItems.forEach(item => {
                let baseStr = item.querySelector(".currency_base_class").value;
                let targetStr = item.querySelector(".currency_target_class").value;

                let currencyDict = {};
                currencyDict[baseStr] = targetStr;
                currencyList.push(currencyDict);
            });

            let categoriesDiv = document.getElementById("categories_list");
            let categoryItems = categoriesDiv.querySelectorAll('.category_row');
            categoryItems.forEach(item => {
                let name = item.querySelector('.category_title').innerHTML;
                let websiteDivs = item.querySelector('[id*="website-list"]').querySelectorAll('.form_row');
                let website_list = [];
                websiteDivs.forEach(subitem => {
                    let name = subitem.querySelector(".content_website_name").value;
                    let url = subitem.querySelector(".content_website_url").value;
                    let websiteData = {};
                    websiteData["name"] = name;
                    websiteData["url"] = url;
                    website_list.push(websiteData);
                });

                let currentContent = {};
                currentContent["name"] = name;
                currentContent["content"] = website_list;
                categoriesList.push(currentContent);
            });

            name = nameInput.value;
            lat = latitudeInput.value;
            lng = longitudeInput.value;
            currentSearchEngine = document.getElementById("search_engine_dropdown").innerHTML;

            let finalJSON = {
                "name": name,
                "latitude": lat,
                "longitude": lng,
                "search_engines": search_engines,
                "current_search_engine": currentSearchEngine,
                "currencies": currencyList,
                "categories": categoriesList,
            };

            var requestOptions = {
              method: "POST",
              headers: {
                "Content-Type": "application/json"
              },
              "X-CSRF-Token": "{{ csrf_token }}",
              body: JSON.stringify(finalJSON)
            };

            fetch('/save_settings/', requestOptions)
                .then(function (response) {
                    if (response.ok){
                        location.reload();
                    }
                });
        }

        function resetSettings() {
            if(window.confirm("Are you sure to reset your settings to default?")){
                fetch("/reset_settings/")
                .then(function () {
                    location.reload();
                });
            }
        }

        function returnToStartPage() {
            window.location.href = "/";
        }

    </script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
</head>
<body class="dark_body settings_body">

    <h1 class="settings_label big_title">Name</h1>
    <div class="form_row">
        <input type="text" class="form-control settings_input_box_small" id="nameOption" placeholder="Enter your name" value="{{ name }}">
    </div><br>

    <h1 class="settings_label big_title">Location</h1>
    <div id="map" style="height: 400px; width: 800px;"></div>
    <form class="form_row">
        <label class="settings_label" for="latitude">Latitude:</label>
        <input type="text" id="latitude" name="latitude" value="{{latitude}}" readonly>
    </form>
    <form class="form_row">
        <label class="settings_label" for="longitude">Longitude:</label>
        <input type="text" id="longitude" name="longitude" value="{{longitude}}" readonly>
    </form><br>


    <h1 class="settings_label big_title">Search Engines</h1>
    <div class="search_engines_div">
        <div id="search_engines">
            {% for engine_name, url in search_engines.items %}
                <div class="form_row">
                    <label class="settings_label mx-2">Name</label>&nbsp;&nbsp;
                    <input type="text" class="form-control settings_input_box_small" placeholder="Name" value="{{ engine_name }}" id="search-engine-name-{{ engine_name|space_to_hyphen }}" readonly>
                    <label class="settings_label mx-2">Url</label>
                    <input type="text" class="form-control settings_input_box_big" placeholder="Url" value="{{ url }}" id="search-engine-url-{{ engine_name|space_to_hyphen }}" readonly>&nbsp;&nbsp;&nbsp;&nbsp;
                    <button class="btn btn-danger settings_plusminus" onclick="removeSearchEngine(this);">X</button>
                </div>
            {% endfor %}
        </div><br>

        <h4 class="settings_label">Add A Search Engine&nbsp;&nbsp;</h4>
        <div class="form_row">
            <label class="settings_label mx-2">Name</label>&nbsp;&nbsp;
            <input type="text" class="form-control settings_input_box_small mx-2" placeholder="Name" id="add_search_engine_name">
            <label class="settings_label mx-2">Url</label>
            <input type="text" class="form-control settings_input_box_big" placeholder="Url. Put %s for the query" id="add_search_engine_url">&nbsp;&nbsp;&nbsp;&nbsp;
            <button class="btn btn-primary settings_plusminus" onclick="addSearchEngine(this);">＋</button>
        </div><br>

        <div class="form_row">
            <h4 class="settings_label">Current Search Engine</h4>&nbsp;&nbsp;
            <div class="dropdown">
                <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown" id="search_engine_dropdown">{{ search_engine_name }}</button>
                <div class="dropdown-menu" id="search-engine-dropdown">
                    {% for engine_name, url in search_engines.items %}
                        <a class="dropdown-item" href="javascript:void(0);" data-value="{{ engine_name }}" onclick="selectItem(this);" id="search-engine-choice-{{ engine_name|space_to_hyphen }}">{{ engine_name }}</a>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

<!--    CURRENCY CONVERSIONS-->
    <h1 class="settings_label big_title">Currency Conversions</h1>
    <div class="currencies_div">
        <div id="currency-list">
            {% for currency in currencies %}
                {% for base, target in currency.items %}
                    <div class="form_row">
                        <label class="settings_label mx-2">Base</label>&nbsp;&nbsp;
                        <input type="text" class="form-control settings_input_box_small currency_base_class" placeholder="Base Currency" value="{{base}}" readonly>
                        <label class="settings_label mx-2">Target</label>
                        <input type="text" class="form-control settings_input_box_small currency_target_class" placeholder="Target Currency" value="{{target}}" readonly>&nbsp;&nbsp;&nbsp;&nbsp;
                        <button class="btn btn-danger settings_plusminus" onclick="removeCurrency(this);">X</button>
                    </div>
                {% endfor %}
            {% endfor %}
        </div><br>
        <h4 class="settings_label">Add A Currency Conversion</h4>
        <div class="form_row">
            <label class="settings_label mx-2">Base</label>&nbsp;&nbsp;
            <input type="text" class="form-control settings_input_box_small" placeholder="Base" id="add-currency-base">
            <label class="settings_label mx-2">Target</label>
            <input type="text" class="form-control settings_input_box_small" placeholder="Target" id="add-currency-target">&nbsp;&nbsp;&nbsp;&nbsp;
            <button class="btn btn-primary settings_plusminus" onclick="addCurrency(this);">＋</button>
        </div><br>
    </div>

<!--    CONTENTS -->
    <h1 class="settings_label big_title">Contents</h1>
    <div class="categories_div">
        <div class="categories-list" id="categories_list">
            {% for category in categories %}
                <div class="category_row">
                    <h2 class="settings_label settings_content_title category_title">{{category.name}}</h2>
                    <div id="{{category.name|space_to_hyphen}}-website-list">
                        {% for content in category.content %}
                            <div class="form_row">
                                <label class="settings_label mx-2">Name</label>&nbsp;&nbsp;
                                <input type="text" class="form-control settings_input_box_small content_website_name" placeholder="Name" value="{{content.name}}" readonly>
                                <label class="settings_label mx-2">Url</label>&nbsp;&nbsp;
                                <input type="text" class="form-control settings_input_box_big content_website_url" placeholder="Url" value="{{content.url}}" readonly>&nbsp;&nbsp;&nbsp;&nbsp;
                                <button class="btn btn-danger settings_plusminus" onclick="removeCategoryItem(this);">X</button>
                            </div>
                        {% endfor %}
                    </div>
                    <br>
                    <h4 class="settings_label">Add a website to this category</h4>
                    <div class="form_row">
                        <label class="settings_label mx-2">Name</label>&nbsp;&nbsp;
                        <input type="text" class="form-control settings_input_box_small" placeholder="Name" id="{{category.name|space_to_hyphen}}-add-website-name">
                        <label class="settings_label mx-2">Url</label>
                        <input type="text" class="form-control settings_input_box_big" placeholder="Url" id="{{category.name|space_to_hyphen}}-add-website-url">&nbsp;&nbsp;&nbsp;&nbsp;
                        <button class="btn btn-primary settings_plusminus" onclick="addWebsiteToCategory(this, '{{category.name|space_to_hyphen}}');">＋</button>
                    </div>
                    <button class="btn btn-danger" onclick="removeCategory(this);">Delete This Category</button>
                    <br><br><br>
                </div>
            {% endfor %}
            <br>
        </div>
        <h2 class="settings_label">Add a category</h2>
        <div class="form_row">
            <label class="settings_label mx-2">Name</label>&nbsp;&nbsp;
            <input type="text" class="form-control settings_input_box_small" placeholder="Name" id="add-category-name">
            <button class="btn btn-primary settings_plusminus mx-2" onclick="addCategory(this);">＋</button>
        </div>
    </div><br><br><br>

    <button class="btn btn-primary" onclick="saveSettings();">Save Settings!</button>
    <button class="btn btn-danger" onclick="resetSettings();">Reset Settings!</button>
    <button class="btn btn-success" onclick="returnToStartPage();">Return to Start Page!</button>

    <script>
        // Initialize the map
        let map = L.map('map').setView([{{latitude}}, {{longitude}}], 13); // Default view is London

        // Add a tile layer (you can use any tile provider)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        // Initialize a marker
        let marker = L.marker([{{latitude}}, {{longitude}}], {
            draggable: true
        }).addTo(map);

        // Update input fields when the marker is dragged
        marker.on('dragend', function (e) {
            let latlng = marker.getLatLng();
            document.getElementById('latitude').value = latlng.lat.toFixed(6);
            document.getElementById('longitude').value = latlng.lng.toFixed(6);
        });
    </script>

</body>
</html>
